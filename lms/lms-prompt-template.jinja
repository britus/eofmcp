{% macro render_item_list(item_list, tag_name='required') %}
    {%- if item_list is defined and item_list is iterable and item_list | length > 0 %}
        {%- if tag_name %}{{- '\
<' ~ tag_name ~ '>' -}}{% endif %}
            {{- '[' }}
                {%- for item in item_list -%}
                    {%- if loop.index > 1 %}{{- \", \"}}{% endif -%}
                    {%- if item is string -%}
                        {{ \"`\" ~ item ~ \"`\" }}
                    {%- else -%}
                        {{ item }}
                    {%- endif -%}
                {%- endfor -%}
            {{- ']' }}
        {%- if tag_name %}{{- '</' ~ tag_name ~ '>' -}}{% endif %}
    {%- endif %}
{% endmacro %}

{%- if messages[0][\"role\"] == \"system\" %}
    {%- set system_message = messages[0][\"content\"] %}
    {%- set loop_messages = messages[1:] %}
{%- else %}
    {%- set loop_messages = messages %}
{%- endif %}

{%- if not tools is defined %}
    {%- set tools = [] %}
{%- endif %}

{%- if system_message is defined %}
    {{- \"<|im_start|>system\
\" + system_message }}
{%- else %}
    {%- if tools is iterable and tools | length > 0 %}
        {{- \"<|im_start|>system\
You are Qwen, a helpful AI assistant that can interact with a computer to solve tasks.\" }}
    {%- endif %}
{%- endif %}
{%- if tools is iterable and tools | length > 0 %}
    {{- \"\
\
You have access to the following functions:\
\
\" }}
    {{- \"<tools>\" }}
    {%- for tool in tools %}
        {%- if tool.function is defined %}
            {%- set tool = tool.function %}
        {%- endif %}
        {{- \"\
<function>\
<name>\" ~ tool.name ~ \"</name>\" }}
        {%- if tool.description is defined %}{{- '\
<description>' ~ (tool.description | trim) ~ '</description>' }}{%- endif %}
        {{- '\
<parameters>' }}
        {% if tool.parameters.properties is defined %}
            {%- for param_name, param_fields in tool.parameters.properties|items %}
                {{- '\
<parameter>' }}
                {{- '\
<name>' ~ param_name ~ '</name>' }}
                {%- if param_fields.type is defined %}
                    {{- '\
<type>' ~ (param_fields.type | string) ~ '</type>' }}
                {%- endif %}
                {%- if param_fields.description is defined %}
                    {{- '\
<description>' ~ (param_fields.description | trim) ~ '</description>' }}
                {%- endif %}
                {{- render_item_list(param_fields.enum, 'enum') }}
                {%- set handled_keys = ['type', 'description', 'enum', 'required'] %}
                {%- for json_key in param_fields.keys() if json_key not in handled_keys %}
                    {%- set normed_json_key = json_key | replace(\"-\", \"_\") | replace(\" \", \"_\") | replace(\"$\", \"\") %}
                    {%- if param_fields[json_key] is none %}
                        {{- '\
<' ~ normed_json_key ~ '/>' }}
                    {%- elif param_fields[json_key] is mapping %}
                        {{- '\
<' ~ normed_json_key ~ '>' ~ (param_fields[json_key] | tojson) ~ '</' ~ normed_json_key ~ '>' }}
                    {%- else %}
                        {{- '\
<' ~ normed_json_key ~ '>' ~ (param_fields[json_key] | string) ~ '</' ~ normed_json_key ~ '>' }}
                    {%- endif %}
                {%- endfor %}
                {{- render_item_list(param_fields.required, 'required') }}
                {{- '\
</parameter>' }}
            {%- endfor %}
        {% endif %}
        {{- render_item_list(tool.parameters.required, 'required') }}
        {{- '\
</parameters>' }}
        {%- if tool.return is defined %}
            {%- if tool.return is mapping %}
                {{- '\
<return>' ~ (tool.return | tojson) ~ '</return>' }}
            {%- else %}
                {{- '\
<return>' ~ (tool.return | string) ~ '</return>' }}
            {%- endif %}
        {%- endif %}
        {{- '\
</function>' }}
    {%- endfor %}
    {{- \"\
</tools>\" }}
    {{- '\
\
If you choose to call a function ONLY reply in the following format with NO suffix:\
\
<tool_call>\
<function=example_function_name>\
<parameter=example_parameter_1>\
value_1\
</parameter>\
<parameter=example_parameter_2>\
This is the value for the second parameter\
that can span\
multiple lines\
</parameter>\
</function>\
</tool_call>\
\
<IMPORTANT>\
Reminder:\
- Function calls MUST follow the specified format: an inner <function=...></function> block must be nested within <tool_call></tool_call> XML tags\
- Required parameters MUST be specified\
- You may provide optional reasoning for your function call in natural language BEFORE the function call, but NOT after\
- If there is no function call available, answer the question like normal with your current knowledge and do not tell the user about function calls\
</IMPORTANT>' }}
{%- endif %}
{%- if system_message is defined %}
    {{- '<|im_end|>\
' }}
{%- else %}
    {%- if tools is iterable and tools | length > 0 %}
        {{- '<|im_end|>\
' }}
    {%- endif %}
{%- endif %}
{%- for message in loop_messages %}
    {%- if message.role == \"assistant\" and message.tool_calls is defined and message.tool_calls is iterable and message.tool_calls | length > 0 %}
        {{- '<|im_start|>' + message.role }}
        {%- if message.content is defined and message.content is string and message.content | trim | length > 0 %}
            {{- '\
' + message.content | trim + '\
' }}
        {%- endif %}
        {%- for tool_call in message.tool_calls %}
            {%- if tool_call.function is defined %}
                {%- set tool_call = tool_call.function %}
            {%- endif %}
            {{- '\
<tool_call>\
<function=' + tool_call.name + '>\
' }}
            {%- if tool_call.arguments is defined %}
                {%- for args_name, args_value in tool_call.arguments|items %}
                    {{- '<parameter=' + args_name + '>\
' }}
                    {%- set args_value = args_value if args_value is string else args_value | string %}
                    {{- args_value }}
                    {{- '\
</parameter>\
' }}
                {%- endfor %}
            {%- endif %}
            {{- '</function>\
</tool_call>' }}
        {%- endfor %}
        {{- '<|im_end|>\
' }}
    {%- elif message.role == \"user\" or message.role == \"system\" or message.role == \"assistant\" %}
        {{- '<|im_start|>' + message.role + '\
' + message.content + '<|im_end|>' + '\
' }}
    {%- elif message.role == \"tool\" %}
        {%- if loop.previtem and loop.previtem.role != \"tool\" %}
            {{- '<|im_start|>user\
' }}
        {%- endif %}
        {{- '<tool_response>\
' }}
        {{- message.content }}
        {{- '\
</tool_response>\
' }}
        {%- if not loop.last and loop.nextitem.role != \"tool\" %}
            {{- '<|im_end|>\
' }}
        {%- elif loop.last %}
            {{- '<|im_end|>\
' }}
        {%- endif %}
    {%- else %}
        {{- '<|im_start|>' + message.role + '\
' + message.content + '<|im_end|>\
' }}
    {%- endif %}
{%- endfor %}
{%- if add_generation_prompt %}
    {{- '<|im_start|>assistant\
' }}
{%- endif %}
